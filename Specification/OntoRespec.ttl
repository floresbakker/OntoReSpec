@prefix dct: <http://purl.org/dc/terms/>.
@prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>.
@prefix doc: <http://www.example.org/document/> .
@prefix function: <https://data.rijksfinancien.nl/html/model/function/>.
@prefix html: <https://data.rijksfinancien.nl/html/model/def/> .
@prefix manchester: <https://data.rijksfinancien.nl/manchester/model/def/> .
@prefix owl: <http://www.w3.org/2002/07/owl#>.
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix respec: <https://respec.org/model/> .
@prefix rule: <https://data.rijksfinancien.nl/html/model/rule/>.
@prefix shp: <https://data.rijksfinancien.nl/html/model/shp/>.
@prefix target: <https://data.rijksfinancien.nl/html/model/target/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.
@prefix skos: <http://www.w3.org/2004/02/skos/core#>.

respec:introduction
	a owl:DatatypeProperty;
    rdfs:domain owl:Ontology;
    rdfs:range xsd:string;
    skos:definition 'Property that links a text, in which an ontology is presented and introduced to an audience, to that very ontology.'@en;
    skos:prefLabel 'has introduction'@en.

shp:Document
  a sh:NodeShape;
  sh:rule rule:Document;
  sh:targetClass respec:TemplateDocument.

rule:Document
  a sh:SPARQLRule;
  skos:prefLabel 'Document rule'@en;
  rdfs:comment 'The Document rule creates a document and attaches its structure.'@en ;
  sh:construct """
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 

construct {
  ?documentID
    a html:Document, respec:Document ;
    ?element ?childID .
    
} where {
  
  $this ?element ?child.
  ?child  a/ rdfs:subClassOf* dom:Element.
  
  # Create identifiers
  bind(iri(concat(str($this),'-instance')) as ?documentID)
  bind(iri(concat(str(?child),'-instance')) as ?childID)
  
}""".

shp:StaticElement
  a sh:NodeShape;
  sh:rule rule:StaticElement;
  sh:targetClass respec:StaticElement.
  
rule:StaticElement
  a sh:SPARQLRule;
  skos:prefLabel 'Static Element rule'@en;
  rdfs:comment 'The Static Element rule creates a unique element and attaches its structure.'@en ;
  sh:construct """
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 

construct {
  ?elementID
    a ?class ;
    rdfs:label ?label;
    html:fragment ?fragment;
    ?element ?childID ;
	?attribute ?attributeValue.
    
} where {
  $this a ?class.
  OPTIONAL {
        $this ?element ?child.
  ?child  a/ rdfs:subClassOf* dom:Element.}
  OPTIONAL {
  $this html:fragment ?fragment}
  OPTIONAL {
  $this rdfs:label ?label}
  OPTIONAL {
  $this ?attribute ?attributeValue.
  ?attribute rdfs:subPropertyOf html:attribute.
  }
  ?class rdfs:subClassOf* dom:Element.
  # Create identifiers
  bind(iri(concat(str($this),'-instance')) as ?elementID)
  bind(iri(concat(str(?child),'-instance')) as ?childID)
  
}""".

shp:OntologyMetadata
  a sh:NodeShape;
  sh:rule rule:Title, rule:Introduction, rule:Description, rule:Example, rule:Abstract, rule:Version, rule:Classes, rule:ObjectProperties, rule:DatatypeProperties, rule:NodeShapes;
  sh:targetClass owl:Ontology.


rule:Title
  a sh:SPARQLRule;
  skos:prefLabel 'Title rule'@en;
  rdfs:comment 'The Title rule creates a title for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>

construct {
  ?titleTextElementID rdf:type html:TextElement;
  html:fragment ?ontologyTitle.
    
} where {
   {?titleTextElement a respec:TitleTextElement}
  optional
  {$this dc:title ?ontologyTitle1}
  optional
  {$this dct:title ?ontologyTitle2}
  optional
  {$this schema:name ?ontologyTitle3}
   
  BIND(COALESCE(?ontologyTitle1, ?ontologyTitle2, ?ontologyTitle3, "Unknown title") as ?ontologyTitle)
  # Create identifiers
  bind(iri(concat(str(?titleTextElement),'-instance')) as ?titleTextElementID)
    
}""".


rule:Introduction
  a sh:SPARQLRule;
  skos:prefLabel 'Introduction rule'@en;
  rdfs:comment 'The Introduction rule creates an introduction for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {
  ?introductionSectionInstance        rdf:type html:Section;
                                      rdf:_1 ?introductionH2;
                                      rdf:_2 ?introductionParagraph;
                                      html:class "informative".
  ?introductionH2                     rdf:type html:H2;
                                      rdf:_1 ?introductionTitle.
  ?introductionTitle                  rdf:type html:TextElement;
                                      html:fragment "Introduction".
  ?introductionParagraph              rdf:type html:P;
                                      rdf:_1 ?introductionText.
  ?introductionText                   rdf:type html:TextElement;
                                      html:fragment ?ontologyIntroduction.  
} where {
   {?introductionSection a respec:Introduction}
    optional
   {$this respec:introduction ?introduction}

  BIND(COALESCE(function:escapeHTML(?introduction), "Introduction not available") as ?ontologyIntroduction)

  # Create identifiers
  bind(iri(concat(str(?introductionSection),'-instance')) as ?introductionSectionInstance)
  bind(iri(concat(str(?introductionSectionInstance),'-1')) as ?introductionH2)
  bind(iri(concat(str(?introductionSectionInstance),'-2')) as ?introductionParagraph)
  bind(iri(concat(str(?introductionH2),'-1')) as ?introductionTitle)
  bind(iri(concat(str(?introductionParagraph),'-1')) as ?introductionText)
    
}""".

rule:Description
  a sh:SPARQLRule;
  skos:prefLabel 'Description rule'@en;
  rdfs:comment 'The Description rule creates a description for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {
  ?descriptionTextElementID rdf:type html:TextElement;
  html:fragment ?ontologyDescription.
    
} where {
   {?textElement a respec:Description}
  optional
  {$this dc:description ?ontologyDescription1}
  optional
  {$this dct:description ?ontologyDescription2}
  optional
  {$this rdfs:comment ?ontologyDescription3}
  optional
  {$this schema:description ?ontologyDescription4}
  optional
  {$this skos:note ?ontologyDescription5}

  BIND(COALESCE(?ontologyDescription1, ?ontologyDescription2, ?ontologyDescription3, ?ontologyDescription4, ?ontologyDescription5,"Description not available") as ?ontologyDescription)
  # Create identifiers
  bind(iri(concat(str(?textElement),'-instance')) as ?descriptionTextElementID)
    
}""".

rule:Example
  a sh:SPARQLRule;
  skos:prefLabel 'Example rule'@en;
  rdfs:comment 'The Example rule creates an example for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {
  ?exampleElementAside   rdf:type html:Aside;
                         html:class 'example';
                         rdf:_1 ?exampleParagraph.
  ?exampleParagraph      rdf:type html:P;
                         rdf:_1 ?examplePre.
  ?examplePre            rdf:type html:Pre;
                         rdf:_1 ?exampleTextElement.
  ?exampleTextElement    rdf:type html:TextElement;
                         html:fragment ?ontologyExample.
} where {
  
  ?exampleElement a respec:Example.
  $this skos:example ?example.
  BIND(function:escapeHTML(?example) as ?ontologyExample)
  
  # Create identifiers
  BIND(IRI(CONCAT(STR(?exampleElement),'-instance')) as ?exampleElementAside)
  BIND(IRI(CONCAT(STR(?exampleElementAside), '-1')) as ?exampleParagraph)
  BIND(IRI(CONCAT(STR(?exampleParagraph),'-1')) as ?examplePre)
  BIND(IRI(CONCAT(STR(?examplePre),'-1')) as ?exampleTextElement)
    
}""".

rule:Abstract
  a sh:SPARQLRule;
  skos:prefLabel 'Abstract rule'@en;
  rdfs:comment 'The Abstract rule creates an abstract for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 

construct {
  ?abstractTextElementID rdf:type html:TextElement;
  html:fragment ?ontologyAbstract.
    
} where {
   {?textElement a respec:Abstract}
  optional
  {$this dc:abstract ?ontologyAbstract1}
  optional
  {$this dct:abstract ?ontologyAbstract2}
  BIND(COALESCE(?ontologyAbstract1, ?ontologyAbstract2, "Abstract not available") as ?ontologyAbstract)
  # Create identifiers
  bind(iri(concat(str(?textElement),'-instance')) as ?abstractTextElementID)
    
}""".       
    

rule:Version
  a sh:SPARQLRule;
  skos:prefLabel 'Version rule'@en;
  rdfs:comment 'The Version rule creates the version information for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix prov: <http://www.w3.org/ns/prov#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>

construct {
  
  ?configurationElementID rdf:type html:TextElement;
  html:fragment ?fragment4.
    
} where {
  
  ?textElement a respec:Configuration;
               html:fragment ?fragment.
  optional
  {$this owl:versionIRI ?ontologyVersion1}
  optional
  {$this schema:schemaVersion ?ontologyVersion2}
  optional
  {$this owl:versionInfo ?ontologyVersionText1}
  optional
  {$this dct:publisher ?workinggroup}
  optional
  {$this dct:source ?github}
  { select (group_concat(?ontologyAuthorString;separator='') as ?ontologyAuthors) 
    {
  optional
  {$this dct:creator ?ontologyAuthor1}
  optional
  {$this dc:creator ?ontologyAuthor2}
  optional
  {$this schema:creator ?ontologyAuthor3}
  optional
  {$this prov:wasAttributedTo ?ontologyAuthor4}

  BIND(COALESCE(?ontologyAuthor1, ?ontologyAuthor2, ?ontologyAuthor3, ?ontologyAuthor4, "Author unknown") as ?ontologyAuthor)
  BIND(CONCAT('{name: "', STR(?ontologyAuthor), '"},') as ?ontologyAuthorString)
    }
  }
  
  BIND(COALESCE(?ontologyVersion1, ?ontologyVersion2, "Version IRI not available") as ?ontologyVersionIRI)
  BIND(REPLACE(?fragment, 'VersionURL', str(?ontologyVersionIRI)) as ?fragment1)
  BIND(REPLACE(?fragment1, 'working-group', str(?workinggroup)) as ?fragment2)
  BIND(REPLACE(?fragment2, 'some-org/mySpec', str(?github)) as ?fragment3)
  BIND(REPLACE(?fragment3, 'name: "Your Name"', str(?ontologyAuthors)) as ?fragment4)
  
  # Create identifiers
  bind(iri(concat(str(?textElement),'-instance')) as ?configurationElementID)
  
}""".  



rule:Classes
  a sh:SPARQLRule;
  skos:prefLabel 'Classes rule'@en;
  rdfs:comment 'The Classes rule creates a section of classes for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix manchester: <https://data.rijksfinancien.nl/manchester/model/def/>
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {

      ?divDefinitionClass1Instance            rdf:type html:Div;
                                              ?memberClassString ?divDefinitionClass2Instance.
      ?divDefinitionClass2Instance            rdf:type html:Section;
                                              rdf:_1 ?class_title_instance_h2;
                                              rdf:_2 ?class_definition_instance;
                                              rdf:_3 ?class_linebreak_instance;  
                                              rdf:_4 ?class_linebreak_instance2;
                                              rdf:_5 ?manchester_syntax_instance.
      ?class_title_instance_h2                rdf:type html:H2;
                                              rdf:_1 ?class_dfn_instance.
      ?class_dfn_instance                     rdf:type html:Dfn;
                                              rdf:_1 ?class_title_text_instance.
      ?class_title_text_instance              rdf:type html:TextElement;
                                              html:fragment ?cleanedManchesterLabel.
      ?class_definition_instance              rdf:type html:TextElement;
                                              html:fragment ?classDefinition.
      ?class_linebreak_instance               rdf:type html:Br.
      ?class_linebreak_instance2              rdf:type html:Br.
      ?manchester_syntax_instance             rdf:type html:Aside;
                                              html:class "note" ;
                                              html:title "Manchester Syntax";
                                              rdf:_1 ?manchester_code_label_instance;
                                              rdf:_2 ?manchester_code_definition_instance.
      ?manchester_code_label_instance         rdf:type html:Code;
                                              rdf:_1 ?manchester_label_link;
                                              rdf:_2 ?colon.
      ?manchester_code_definition_instance    rdf:type html:Code;
                                              ?memberManchesterString  ?manchester_definition_block.
      ?manchester_label_link                  rdf:type html:A;
                                              rdf:_1 ?manchester_label_instance.
      ?colon                                  rdf:type html:TextElement;
                                              html:fragment ":".
      ?manchester_label_instance              rdf:type html:TextElement;
                                              html:fragment ?cleanedManchesterLabel.
      ?manchester_definition_block            rdf:type html:P;
                                              rdf:_1 ?manchester_definition_instance;
                                              rdf:_2 ?class_linebreak_instance3.
      ?manchester_definition_instance         rdf:type html:TextElement;
                                              html:fragment ?manchesterDefinition.
      ?class_linebreak_instance3              rdf:type html:Br.
}
where  {
   
   # Get the template 
   
   {?divDefinitionClass1 rdf:type respec:ClassDefinition.

   }

   # Get the class from the ontology, the label and description, and the sequence order in which the class appears amidst other classes alphanumerically.
   
   {SELECT ?class ?manchesterLabel ?classDefinition_original (COUNT(?prevClass) + 1 AS ?memberClass)
    WHERE {
      ?class a owl:Class .
      ?class skos:definition ?classDefinition_original.
      ?class manchester:label ?manchesterLabel.
      
    OPTIONAL {
    ?prevClass a owl:Class .
    ?prevClass manchester:label ?prevLabel .
    FILTER(?prevLabel < ?manchesterLabel)
     }
    }
    GROUP BY ?class ?manchesterLabel ?classDefinition
    ORDER BY ?manchesterLabel # order alphanumerically so that the class definitions appear in the correct order
   }
   BIND(IRI(CONCAT(str(rdf:),"_", str(?memberClass))) as ?memberClassString) #this is the rdf:_x property that indicates the order in which the class appears
   BIND(function:escapeHTML(concat(str(?manchesterLabel), ': ')) as ?manchesterLabelColon)
   BIND(function:escapeHTML(?classDefinition_original) as ?classDefinition)

   {SELECT ?class ?manchesterDefinition (COUNT(?prevManchesterDefinition) + 1 AS ?memberManchester)
    WHERE {
      ?class a owl:Class .
      ?class manchester:definition ?manchesterDefinition.  
    OPTIONAL {
      ?class manchester:definition ?prevManchesterDefinition .
    FILTER(?prevManchesterDefinition < ?manchesterDefinition)
    }
   }
   GROUP BY ?class ?manchesterDefinition
   ORDER BY ?manchesterDefinition # order alphanumerically so that the class definitions appear in the correct order
   }
  
  BIND(IRI(CONCAT(str(rdf:),"_", str(?memberManchester))) as ?memberManchesterString) #this is the rdf:_x property that indicates the order in which the manchester definition appears
  BIND(function:escapeHTML(?manchesterLabel) as ?cleanedManchesterLabel)
  
  # Create identifiers - generic
  
  bind(IRI(CONCAT(STR(?divDefinitionClass1),'-instance')) as ?divDefinitionClass1Instance)
  bind(IRI(CONCAT(STR(?divDefinitionClass1Instance), '-', str(?memberClass),'-1')) as ?divDefinitionClass2Instance)
  bind(IRI(CONCAT(STR(?divDefinitionClass2Instance), '-1')) as ?class_title_instance_h2)
  bind(IRI(CONCAT(STR(?divDefinitionClass2Instance), '-2')) as ?class_definition_instance)
  bind(IRI(CONCAT(STR(?divDefinitionClass2Instance), '-3')) as ?class_linebreak_instance)
  bind(IRI(CONCAT(STR(?divDefinitionClass2Instance), '-4')) as ?class_linebreak_instance2)
  bind(IRI(CONCAT(STR(?divDefinitionClass2Instance), '-5')) as ?manchester_syntax_instance)
  bind(IRI(CONCAT(STR(?class_title_instance_h2), '-1')) as ?class_dfn_instance)
  bind(IRI(CONCAT(STR(?class_dfn_instance), '-1')) as ?class_title_text_instance)
    
  # Create identifiers - Manchester Syntax 

  bind(IRI(CONCAT(STR(?manchester_syntax_instance), '-1')) as ?manchester_code_label_instance)  
  bind(IRI(CONCAT(STR(?manchester_syntax_instance), '-2')) as ?manchester_code_definition_instance)  
  bind(IRI(CONCAT(STR(?manchester_code_label_instance), '-1')) as ?manchester_label_link)
  bind(IRI(CONCAT(STR(?manchester_code_label_instance), '-2')) as ?colon)
  bind(IRI(CONCAT(STR(?manchester_label_link), '-1')) as ?manchester_label_instance)
  bind(IRI(CONCAT(STR(?manchester_code_definition_instance), '-',str(?memberManchester))) as ?manchester_definition_block)
  bind(IRI(CONCAT(STR(?manchester_definition_block), '-1')) as ?manchester_definition_instance)
  bind(IRI(CONCAT(STR(?manchester_definition_block), '-2')) as ?class_linebreak_instance3)
  
}
""".

rule:ObjectProperties
  a sh:SPARQLRule;
  skos:prefLabel 'Object properties rule'@en;
  rdfs:comment 'The object properties rule creates a section of object properties for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {

      ?divDefinitionObjectProperty1Instance rdf:type html:Div;
                                            ?memberObjectPropertyString ?divDefinitionObjectProperty2Instance.
      ?divDefinitionObjectProperty2Instance rdf:type html:Section;
                                   rdf:_1 ?objectProperty_title_instance_h2;
                                   rdf:_2 ?objectProperty_definition_instance.
      ?objectProperty_title_instance_h2     rdf:type html:H2;
                                   ?memberTitle ?objectProperty_dfn_instance.
      ?objectProperty_dfn_instance          rdf:type html:Dfn;
                                   ?memberDfn ?objectProperty_title_text_instance.
      ?objectProperty_title_text_instance   rdf:type html:TextElement;
                                   html:fragment ?objectPropertyLabel2.
      ?objectProperty_definition_instance   rdf:type html:TextElement;
                                   html:fragment ?objectPropertyDefinition.
    
}
where  {
   {?sectionDefinition rdf:type html:Section;
                       ?member ?divDefinitionObjectProperty1.
    ?divDefinitionObjectProperty1 rdf:type respec:ObjectPropertyDefinitionDiv;
                       ?memberDiv ?divDefinitionObjectProperty2.
    ?divDefinitionObjectProperty2 rdf:type respec:ObjectPropertyDefinitionInstance;
                        rdf:_1 ?H2_class_title;
                        rdf:_2 ?P_class_definition.
    ?H2_class_title a respec:ObjectProperty;
                        ?memberTitle ?objectProperty_dfn.
    ?objectProperty_dfn rdf:type respec:ObjectPropertyDfn;
                        ?memberDfn ?objectProperty_title.
    ?objectProperty_title        rdf:type respec:ObjectPropertyTitle.
    ?P_class_definition rdf:type respec:ObjectProperty;
                        ?memberText ?objectProperty_definition_text.
    ?objectProperty_definition_text a respec:ObjectPropertyDefinitionText.
  }
   
   {SELECT ?objectProperty ?objectPropertyLabel ?objectPropertyDefinition (COUNT(?prevObjectProperty) + 1 AS ?memberObjectProperty)
WHERE {
  ?objectProperty a owl:ObjectProperty .
  ?objectProperty skos:prefLabel ?objectPropertyLabel .
  ?objectProperty skos:definition ?objectPropertyDefinition_original.
  BIND(function:escapeHTML(?objectPropertyDefinition_original) as ?objectPropertyDefinition)
  OPTIONAL {
    ?prevObjectProperty a owl:ObjectProperty .
    ?prevObjectProperty skos:prefLabel ?prevLabel .
    FILTER(?prevLabel < ?objectPropertyLabel)
  }
}
  GROUP BY ?objectPropertyLabel ?objectProperty ?objectPropertyDefinition
  ORDER BY ?objectPropertyLabel
}
  BIND (IRI(CONCAT(str(rdf:),"_", str(?memberObjectProperty))) as ?memberObjectPropertyString)

  # Create identifiers
  bind(COALESCE(?objectPropertyLabel, "Unknown class label") as ?objectPropertyLabel2)
  bind(IRI(CONCAT(STR(?sectionDefinition), '-instance')) as ?sectionDefinitionInstance)
  bind(IRI(CONCAT(STR(?divDefinitionObjectProperty1),'-instance')) as ?divDefinitionObjectProperty1Instance)
  bind(IRI(CONCAT(STR(?divDefinitionObjectProperty2), '-', str(?memberObjectProperty),'-instance')) as ?divDefinitionObjectProperty2Instance)
  bind(IRI(CONCAT(STR(?objectProperty_title), '-', str(?memberObjectProperty), '-instance')) as ?objectProperty_title_text_instance)
  bind(IRI(CONCAT(STR(?H2_class_title), '-', str(?memberObjectProperty), '-instance')) as ?objectProperty_title_instance_h2)
  bind(IRI(CONCAT(STR(?objectProperty_definition_text), '-', str(?memberObjectProperty), '-instance')) as ?objectProperty_definition_instance)
  bind(IRI(CONCAT(STR(?objectProperty_dfn), '-', str(?memberObjectProperty), '-instance')) as ?objectProperty_dfn_instance)
  
}
""".

rule:DatatypeProperties
  a sh:SPARQLRule;
  skos:prefLabel 'Datatype properties rule'@en;
  rdfs:comment 'The datatype properties rule creates a section of datatype properties for the ontology in the document.'@en ;
  sh:construct """
prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix manchester: <https://data.rijksfinancien.nl/manchester/model/def/>
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {

      ?datatypeproperty_div                   rdf:type html:Div;
                                              ?rdf_member ?datatypeproperty_section.
      ?datatypeproperty_section               rdf:type html:Section;
                                              rdf:_1 ?datatypeproperty_H2_title;
                                              rdf:_2 ?datatypeproperty_definition;
                                              rdf:_3 ?linebreak;  
                                              rdf:_4 ?linebreak2;
                                              rdf:_5 ?manchester_syntax.
      ?datatypeproperty_H2_title              rdf:type html:H2;
                                              rdf:_1 ?datatypeproperty_dfn.
      ?datatypeproperty_dfn                   rdf:type html:Dfn;
                                              rdf:_1 ?datatypeproperty_title.
      ?datatypeproperty_title                 rdf:type html:TextElement;
                                              html:fragment ?datatypePropertyLabel_text.
      ?datatypeproperty_definition            rdf:type html:TextElement;
                                              html:fragment ?datatypePropertyDefinition_text.
      ?linebreak                              rdf:type html:Br.
      ?linebreak2                             rdf:type html:Br.
      ?manchester_syntax                      rdf:type html:Aside;
                                              html:class "note" ;
                                              html:title "Manchester Syntax";
                                              rdf:_1 ?manchester_code_label;
                                              rdf:_2 ?manchester_code_domain.
      ?manchester_code_label                  rdf:type html:Code;
                                              rdf:_1 ?manchester_label.
      ?manchester_code_domain                 rdf:type html:Code;
                                              rdf:_1  ?manchester_domain_paragraph.
      ?manchester_label                       rdf:type html:TextElement;
                                              html:fragment ?datatypePropertyManchesterLabel.
      ?manchester_domain_paragraph            rdf:type html:P;
                                              rdf:_1 ?manchester_domain;
                                              rdf:_2 ?linebreak3.
      ?manchester_domain                      rdf:type html:TextElement;
                                              html:fragment ?datatypePropertyManchesterDomain.
      ?linebreak3                             rdf:type html:Br.

}
where  {
   {?datatypeproperty_Template rdf:type respec:DatatypeProperty.}
   
   {SELECT ?datatypeProperty ?datatypePropertyLabel ?datatypePropertyManchesterLabel ?datatypePropertyManchesterDomain ?datatypePropertyDefinition_text (COUNT(?prevDatatypeProperty) + 1 AS ?member)
WHERE {
  ?datatypeProperty a owl:DatatypeProperty .
  ?datatypeProperty skos:prefLabel ?datatypePropertyLabel .
  ?datatypeProperty skos:definition ?datatypePropertyDefinition_original.
  ?datatypeProperty manchester:domain ?datatypePropertyManchesterDomain_original.
  ?datatypeProperty manchester:label ?datatypePropertyManchesterLabel.
  
  BIND(function:escapeHTML(?datatypePropertyDefinition_original) as ?datatypePropertyDefinition_text)
  BIND(function:escapeHTML(?datatypePropertyManchesterDomain_original) as ?datatypePropertyManchesterDomain)
  
  OPTIONAL {
    ?prevDatatypeProperty a owl:DatatypeProperty .
    ?prevDatatypeProperty skos:prefLabel ?prevLabel .
    FILTER(?prevLabel < ?datatypePropertyLabel)
  }
}
  GROUP BY ?datatypePropertyLabel ?datatypeProperty ?datatypePropertyDefinition
  ORDER BY ?datatypePropertyLabel
}
  BIND(IRI(CONCAT(str(rdf:),"_", str(?member))) as ?rdf_member)  
  BIND(COALESCE(?datatypePropertyLabel, "Unknown class label") as ?datatypePropertyLabel_text)

  # Create identifiers
  
  BIND(IRI(CONCAT(STR(?datatypeproperty_Template),'-instance'))                   as ?datatypeproperty_div)
  BIND(IRI(CONCAT(STR(?datatypeproperty_div), '-', str(?member)))                 as ?datatypeproperty_section)
  BIND(IRI(CONCAT(STR(?datatypeproperty_section), '-1'))                          as ?datatypeproperty_H2_title) 
  BIND(IRI(CONCAT(STR(?datatypeproperty_H2_title), '-1'))                         as ?datatypeproperty_dfn)
  BIND(IRI(CONCAT(STR(?datatypeproperty_dfn), '-1'))                              as ?datatypeproperty_title)
  BIND(IRI(CONCAT(STR(?datatypeproperty_section), '-2'))                          as ?datatypeproperty_definition)
  BIND(IRI(CONCAT(STR(?datatypeproperty_section), '-3'))                          as ?linebreak)
  BIND(IRI(CONCAT(STR(?datatypeproperty_section), '-4'))                          as ?linebreak2)
  BIND(IRI(CONCAT(STR(?datatypeproperty_section), '-5'))                          as ?manchester_syntax)

  # Create identifiers - Manchester Syntax 

  BIND(IRI(CONCAT(STR(?manchester_syntax), '-1'))           as ?manchester_code_label)  
  BIND(IRI(CONCAT(STR(?manchester_syntax), '-2'))           as ?manchester_code_domain)  
  BIND(IRI(CONCAT(STR(?manchester_code_label), '-1'))       as ?manchester_label)
  BIND(IRI(CONCAT(STR(?manchester_code_domain), '-1'))      as ?manchester_domain_paragraph)
  BIND(IRI(CONCAT(STR(?manchester_domain_paragraph), '-1')) as ?manchester_domain)
  BIND(IRI(CONCAT(STR(?manchester_domain_paragraph), '-2')) as ?linebreak3)
}
""".

rule:NodeShapes
  a sh:SPARQLRule;
  skos:prefLabel 'Node shapes rule'@en;
  rdfs:comment 'The node shapes rule creates a section of node shapes for the ontology in the document.'@en ;
  sh:construct """

prefix dct: <http://purl.org/dc/terms/>
prefix dc:  <http://purl.org/dc/elements/1.1/>
prefix dom: <https://data.rijksfinancien.nl/dom/model/def/>
prefix function: <https://data.rijksfinancien.nl/html/model/function/>
prefix html: <https://data.rijksfinancien.nl/html/model/def/> 
prefix owl: <http://www.w3.org/2002/07/owl#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> 
prefix respec: <https://respec.org/model/> 
prefix schema: <http://schema.org/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

construct {

      ?divDefinitionNodeShape1Instance rdf:type html:Div;
                                       ?memberNodeShapeString ?divDefinitionNodeShape2Instance.
      ?divDefinitionNodeShape2Instance rdf:type html:Section;
                                   rdf:_1 ?nodeShape_title_instance_h2;
                                   rdf:_2 ?nodeShape_definition_instance.
      ?nodeShape_title_instance_h2     rdf:type html:H2;
                                   ?memberTitle ?nodeShape_dfn_instance.
      ?nodeShape_dfn_instance          rdf:type html:Dfn;
                                   ?memberDfn ?nodeShape_title_text_instance.
      ?nodeShape_title_text_instance   rdf:type html:TextElement;
                                   html:fragment ?nodeShapeLabel2.
      ?nodeShape_definition_instance   rdf:type html:TextElement;
                                   html:fragment ?nodeShapeDefinition.
    
}
where  {
   {?sectionDefinition rdf:type html:Section;
                       ?member ?divDefinitionNodeShape1.
    ?divDefinitionNodeShape1 rdf:type respec:NodeShapeDefinitionDiv;
                       ?memberDiv ?divDefinitionNodeShape2.				   				  
    ?divDefinitionNodeShape2 rdf:type respec:NodeShapeDefinitionInstance;       
                        rdf:_1 ?H2_class_title;
                        rdf:_2 ?P_class_definition.
    ?H2_class_title a respec:NodeShape;
                        ?memberTitle ?nodeShape_dfn.
    ?nodeShape_dfn rdf:type respec:NodeShapeDfn;
                            ?memberDfn ?nodeShape_title.
    ?nodeShape_title        rdf:type respec:NodeShapeTitle.
    ?P_class_definition rdf:type respec:NodeShape;
                        ?memberText ?nodeShape_definition_text.
     ?nodeShape_definition_text a respec:NodeShapeDefinitionText.
  }
   
   {SELECT ?nodeShape ?nodeShapeLabel ?nodeShapeDefinition (COUNT(?prevNodeShape) + 1 AS ?memberNodeShape)
WHERE {
  ?nodeShape a sh:NodeShape .
  ?nodeShape skos:prefLabel ?nodeShapeLabel .
  OPTIONAL{
  ?nodeShape skos:definition ?nodeShapeDefinition_original.}
  BIND(function:escapeHTML(COALESCE(?nodeShapeDefinition_original, "No description available")) as ?nodeShapeDefinition)
  OPTIONAL {
    ?prevNodeShape a sh:NodeShape .
    ?prevNodeShape skos:prefLabel ?prevLabel .
    FILTER(?prevLabel < ?nodeShapeLabel)
  }
}
  GROUP BY ?nodeShapeLabel ?nodeShape ?nodeShapeDefinition
  ORDER BY ?nodeShapeLabel
}
  BIND (IRI(CONCAT(str(rdf:),"_", str(?memberNodeShape))) as ?memberNodeShapeString)

  # Create identifiers
  bind(COALESCE(?nodeShapeLabel, "Unknown class label") as ?nodeShapeLabel2)
  bind(IRI(CONCAT(STR(?sectionDefinition), '-instance')) as ?sectionDefinitionInstance)
  bind(IRI(CONCAT(STR(?divDefinitionNodeShape1),'-instance')) as ?divDefinitionNodeShape1Instance)
  bind(IRI(CONCAT(STR(?divDefinitionNodeShape2), '-', str(?memberNodeShape),'-instance')) as ?divDefinitionNodeShape2Instance)
  bind(IRI(CONCAT(STR(?nodeShape_title), '-', str(?memberNodeShape), '-instance')) as ?nodeShape_title_text_instance)
  bind(IRI(CONCAT(STR(?H2_class_title), '-', str(?memberNodeShape), '-instance')) as ?nodeShape_title_instance_h2)
  bind(IRI(CONCAT(STR(?nodeShape_definition_text), '-', str(?memberNodeShape), '-instance')) as ?nodeShape_definition_instance)
  bind(IRI(CONCAT(STR(?nodeShape_dfn), '-', str(?memberNodeShape), '-instance')) as ?nodeShape_dfn_instance)
  
}
""".

function:escapeHTML
    a sh:SPARQLFunction ;
    rdfs:comment "Escapes HTML characters in the input string." ;
    sh:parameter [
        sh:path function:input ;
        sh:datatype xsd:string ;
        sh:description "The input string to escape HTML characters from." ;
    ] ;
    sh:returnType xsd:string ;
    sh:select """
       SELECT ?result WHERE {
       BIND(replace(
                    replace(
                        replace(
                            replace(
                                replace(
                                    $input,
                                    '&', '&amp;', 'g'),
                                '<', '&lt;', 'g'),
                            '>', '&gt;', 'g'),
                        '\"', '&quot;', 'g'),
                    "\'", '&apos;', 'g')
                AS ?result).
        }
        """ .
